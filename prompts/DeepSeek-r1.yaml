_id: DeepSeekR1
templateFormat: hf
type: system
prompt:
  bos_token: '<｜begin▁of▁sentence｜>'
  eos_token: "<｜end▁of▁sentence｜>"
supports: ['tools']
template: >-
  {% set ns = namespace(is_tool=false, is_output_first=true) %}
  {%- for message in messages %}
    {%- if loop.first and system and messages[0]['role'] != 'system' %}
      {{- '' + system -}}
    {%- endif %}
    {%- if message['role'] == 'system' -%}
      {{- '' + message['content'] -}}
    {%- elif message['role'] == 'user' -%}
      {%- set ns.is_tool = false -%}
      {{- '<｜User｜>' + message['content'] -}}
    {%- elif message['role'] == 'assistant' -%}
      {%- set ns.is_tool = false -%}
      {%- set has_content = false -%}
      {%- if message['tool_calls'] and message['tool_calls']|length > 0 %}
        {%- set has_content = true -%}
        {{'<｜Assistant｜><｜tool▁calls▁begin｜>'}}
        {%- for tool in message['tool_calls'] %}
          {%- set tool_call = '<｜tool▁call▁begin｜>' + tool['type'] + '<｜tool▁sep｜>' + tool['function']['name'] + '\n' + '```json' + '\n' + tool['function']['arguments'] + '\n' + '```' + '<｜tool▁call▁end｜>' -%}
          {%- if loop.first %}
            {{- tool_call}}
          {%- else %}
            {{- '\n' + tool_call}}
          {%- endif %}
        {%- endfor %}
        {{-'<｜tool▁calls▁end｜>'}}
      {%- endif -%}
      {%- if message['content'] %}
        {%- set has_content = true -%}
        {%- set content = message['content'] -%}
        {%- if ns.is_tool %}
          {{'<｜tool▁outputs▁end｜>' + content}}
          {%- set ns.is_tool = false -%}
        {%- else %}
          {% if '</think>' in content %}
            {% set content = (content.split('</think>'))[-1] %}
          {% endif %}
          {{- '<｜Assistant｜>' + content -}}
        {%- endif -%}
      {%- endif -%}
      {%- if has_content and not loop.last %}{{ eos_token }}{% endif %}
    {%- elif message['role'] == 'tool' -%}
      {%- set ns.is_tool = true -%}
      {%- if ns.is_output_first %}
        {{-'<｜tool▁outputs▁begin｜><｜tool▁output▁begin｜>' + message['content'] + '<｜tool▁output▁end｜>'}}
        {%- set ns.is_output_first = false %}
      {%- else %}
        {{'\n<｜tool▁output▁begin｜>' + message['content'] + '<｜tool▁output▁end｜>'}}
      {%- endif %}
    {%- endif -%}
  {%- endfor -%}
  {%- if ns.is_tool %}
    {{-'<｜tool▁outputs▁end｜>'}}
  {%- endif %}
  {%- if add_generation_prompt and messages[-1]['role'] != 'assistant' -%}
      {{-'<｜Assistant｜>'-}}
  {%- endif -%}
modelPattern:
  - !re /(?:^|[-_])(deepseek-r1)(?:[-_]|$)/i
priority: 10